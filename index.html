<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>9Cloud — Teamwork Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-primary: #0f1117;
      --bg-secondary: #161820;
      --bg-card: #1c1e28;
      --bg-card-hover: #22242f;
      --border: #2a2d3a;
      --border-light: #333649;
      --text-primary: #e8eaed;
      --text-secondary: #9ca0b0;
      --text-muted: #6b7084;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-subtle: rgba(59, 130, 246, 0.1);
      --green: #22c55e;
      --green-subtle: rgba(34, 197, 94, 0.12);
      --amber: #f59e0b;
      --amber-subtle: rgba(245, 158, 11, 0.12);
      --red: #ef4444;
      --red-subtle: rgba(239, 68, 68, 0.12);
      --purple: #a78bfa;
      --purple-subtle: rgba(167, 139, 250, 0.1);
      --radius: 10px;
      --radius-sm: 6px;
      --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.2);
    }

    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ─── HEADER ─── */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
    }
    .header-left { display: flex; align-items: center; gap: 14px; }
    .logo {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 14px; color: #fff;
    }
    .header-title { font-size: 18px; font-weight: 600; letter-spacing: -0.3px; }
    .header-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 1px; }
    .header-actions { display: flex; align-items: center; gap: 10px; }

    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-family: inherit; font-size: 13px; font-weight: 500;
      cursor: pointer; transition: all 0.15s;
    }
    .btn:hover { background: var(--bg-card-hover); border-color: var(--border-light); }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn.loading { opacity: 0.6; pointer-events: none; }

    /* ─── STATUS BAR ─── */
    .status-bar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 10px 32px;
      display: flex; align-items: center; gap: 20px;
      font-size: 12px; color: var(--text-muted);
    }
    .status-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--green); display: inline-block; margin-right: 6px;
      animation: pulse 2s infinite;
    }
    .status-dot.error { background: var(--red); animation: none; }
    .status-dot.loading { background: var(--amber); }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .stat-chip {
      background: var(--bg-card);
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* ─── LAYOUT ─── */
    .main { padding: 24px 32px; max-width: 1440px; margin: 0 auto; }

    /* ─── FILTERS ─── */
    .filters-bar {
      display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
      margin-bottom: 24px;
    }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-label {
      font-size: 11px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .filter-select, .filter-date {
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-family: inherit; font-size: 13px;
      min-width: 180px;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    .filter-select:hover, .filter-date:hover { border-color: var(--border-light); }
    .filter-select:focus, .filter-date:focus { border-color: var(--accent); outline: none; }
    .filter-date { min-width: 150px; }
    .filter-date::-webkit-calendar-picker-indicator { filter: invert(0.7); }
    .filter-reset {
      align-self: flex-end;
      font-size: 12px; color: var(--accent);
      background: none; border: none; cursor: pointer;
      font-family: inherit; padding: 8px 4px;
    }
    .filter-reset:hover { text-decoration: underline; }

    /* ─── VIEW TOGGLE ─── */
    .view-toggle {
      display: flex; align-items: center;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-sm); overflow: hidden;
      margin-left: auto;
    }
    .view-toggle button {
      padding: 7px 14px; border: none; background: none;
      color: var(--text-muted); font-family: inherit; font-size: 12px;
      font-weight: 500; cursor: pointer; transition: all 0.15s;
    }
    .view-toggle button.active {
      background: var(--accent-subtle); color: var(--accent);
    }

    /* ─── CHART SECTION ─── */
    .chart-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 24px;
    }
    .chart-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
    }
    .chart-title { font-size: 14px; font-weight: 600; }
    .chart-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    /* ─── STAFF SECTIONS ─── */
    .staff-section {
      margin-bottom: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .staff-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
    }
    .staff-header:hover { background: var(--bg-card-hover); }
    .staff-info { display: flex; align-items: center; gap: 12px; }
    .staff-avatar {
      width: 34px; height: 34px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 13px; color: #fff;
      flex-shrink: 0;
    }
    .staff-name { font-weight: 600; font-size: 14px; }
    .staff-badges { display: flex; gap: 8px; align-items: center; }
    .badge {
      padding: 3px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 600;
    }
    .badge-total { background: var(--accent-subtle); color: var(--accent); }
    .badge-complete { background: var(--green-subtle); color: var(--green); }
    .badge-overdue { background: var(--red-subtle); color: var(--red); }
    .badge-active { background: var(--amber-subtle); color: var(--amber); }
    .collapse-icon {
      color: var(--text-muted); font-size: 18px;
      transition: transform 0.2s;
    }
    .collapse-icon.collapsed { transform: rotate(-90deg); }

    /* ─── TASK TABLE ─── */
    .task-table { width: 100%; border-collapse: collapse; }
    .task-table th {
      text-align: left; padding: 10px 20px;
      font-size: 11px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-primary);
    }
    .task-table td {
      padding: 10px 20px;
      font-size: 13px;
      border-bottom: 1px solid rgba(42, 45, 58, 0.5);
      vertical-align: top;
    }
    .task-table tr:last-child td { border-bottom: none; }
    .task-table tr:hover td { background: rgba(59, 130, 246, 0.03); }

    .task-name-cell { max-width: 400px; }
    .task-title { font-weight: 500; color: var(--text-primary); }
    .task-project-tag {
      display: inline-block; margin-top: 4px;
      font-size: 11px; color: var(--purple);
      background: var(--purple-subtle);
      padding: 2px 8px; border-radius: 4px;
    }
    .status-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 3px 10px; border-radius: 20px;
      font-size: 12px; font-weight: 500;
    }
    .status-complete { background: var(--green-subtle); color: var(--green); }
    .status-active { background: var(--accent-subtle); color: var(--accent); }
    .status-overdue { background: var(--red-subtle); color: var(--red); }

    .date-cell { white-space: nowrap; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
    .date-overdue { color: var(--red); }
    .date-upcoming { color: var(--amber); }
    .date-ok { color: var(--text-secondary); }
    .no-date { color: var(--text-muted); font-style: italic; font-family: 'DM Sans', sans-serif; }

    .priority-dot {
      width: 8px; height: 8px; border-radius: 50%;
      display: inline-block;
    }
    .priority-high { background: var(--red); }
    .priority-medium { background: var(--amber); }
    .priority-low { background: var(--green); }
    .priority-none { background: var(--text-muted); }

    /* ─── LOADING / EMPTY ─── */
    .loading-state {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 80px 20px; gap: 16px;
    }
    .spinner {
      width: 32px; height: 32px; border-radius: 50%;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 14px; color: var(--text-muted); }

    .empty-state {
      text-align: center; padding: 60px 20px;
      color: var(--text-muted); font-size: 14px;
    }

    .error-banner {
      background: var(--red-subtle);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius);
      padding: 14px 20px;
      margin-bottom: 20px;
      color: var(--red);
      font-size: 13px;
    }

    /* ─── RESPONSIVE ─── */
    @media (max-width: 768px) {
      .header, .status-bar, .main { padding-left: 16px; padding-right: 16px; }
      .filters-bar { flex-direction: column; align-items: stretch; }
      .filter-select, .filter-date { min-width: 100%; }
      .view-toggle { margin-left: 0; }
      .task-table { font-size: 12px; }
      .task-table th, .task-table td { padding: 8px 12px; }
      .task-name-cell { max-width: 200px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.1.16/umd/Recharts.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;
    const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, PieChart, Pie } = Recharts;

    const API_BASE = '/api/teamwork';

    // ─── Helpers ───
    function api(endpoint, params = {}) {
      const query = new URLSearchParams({ endpoint, ...params });
      return fetch(`${API_BASE}?${query}`).then(r => {
        if (!r.ok) throw new Error(`API ${r.status}`);
        return r.json();
      });
    }

    function parseDate(str) {
      if (!str) return null;
      // Teamwork returns YYYYMMDD or YYYY-MM-DD
      const clean = str.replace(/-/g, '');
      if (clean.length === 8) {
        return new Date(clean.slice(0,4), parseInt(clean.slice(4,6))-1, clean.slice(6,8));
      }
      return new Date(str);
    }

    function formatDate(d) {
      if (!d) return null;
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function isOverdue(task) {
      if (task.completed) return false;
      if (!task['due-date']) return false;
      const due = parseDate(task['due-date']);
      return due && due < new Date();
    }

    function isUpcomingSoon(task) {
      if (task.completed || !task['due-date']) return false;
      const due = parseDate(task['due-date']);
      const now = new Date();
      const threeDays = new Date(now.getTime() + 3 * 86400000);
      return due && due >= now && due <= threeDays;
    }

    function getTaskStatus(task) {
      if (task.completed) return 'complete';
      if (isOverdue(task)) return 'overdue';
      return 'active';
    }

    function getInitials(name) {
      return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
    }

    const COLORS = ['#3b82f6', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899', '#f97316', '#14b8a6', '#6366f1'];

    // ─── App ───
    function App() {
      const [tasks, setTasks] = useState([]);
      const [projects, setProjects] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [lastUpdated, setLastUpdated] = useState(null);

      // Filters
      const [filterProject, setFilterProject] = useState('all');
      const [filterDateFrom, setFilterDateFrom] = useState('');
      const [filterDateTo, setFilterDateTo] = useState('');
      const [viewMode, setViewMode] = useState('table'); // table | chart

      // Collapse state
      const [collapsedStaff, setCollapsedStaff] = useState({});

      const fetchData = useCallback(async () => {
        setLoading(true);
        setError(null);
        try {
          // Fetch tasks (page through if needed) and projects
          const [tasksRes, projectsRes] = await Promise.all([
            api('tasks.json', { 'page': '1', 'pageSize': '250', 'includeCompletedTasks': 'true' }),
            api('projects.json', { status: 'active' }),
          ]);

          const allTasks = (tasksRes['todo-items'] || []);
          const allProjects = (projectsRes.projects || []);

          setTasks(allTasks);
          setProjects(allProjects);
          setLastUpdated(new Date());
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      }, []);

      useEffect(() => { fetchData(); }, [fetchData]);

      // ─── Filtering ───
      const filteredTasks = useMemo(() => {
        return tasks.filter(task => {
          // Project filter
          if (filterProject !== 'all' && String(task['project-id']) !== filterProject) return false;

          // Date filter
          if (filterDateFrom || filterDateTo) {
            const due = parseDate(task['due-date']);
            if (!due) return false;
            if (filterDateFrom && due < new Date(filterDateFrom)) return false;
            if (filterDateTo && due > new Date(filterDateTo + 'T23:59:59')) return false;
          }

          return true;
        });
      }, [tasks, filterProject, filterDateFrom, filterDateTo]);

      // ─── Group by Staff ───
      const staffGroups = useMemo(() => {
        const groups = {};
        filteredTasks.forEach(task => {
          const name = task['responsible-party-summary'] || 'Unassigned';
          if (!groups[name]) groups[name] = [];
          groups[name].push(task);
        });

        // Sort by number of tasks descending
        return Object.entries(groups)
          .sort((a, b) => b[1].length - a[1].length)
          .map(([name, tasks]) => ({
            name,
            tasks: tasks.sort((a, b) => {
              // Sort: overdue first, then by due date
              const aOverdue = isOverdue(a) ? 0 : 1;
              const bOverdue = isOverdue(b) ? 0 : 1;
              if (aOverdue !== bOverdue) return aOverdue - bOverdue;
              const aDate = parseDate(a['due-date']);
              const bDate = parseDate(b['due-date']);
              if (!aDate && !bDate) return 0;
              if (!aDate) return 1;
              if (!bDate) return -1;
              return aDate - bDate;
            }),
            total: tasks.length,
            complete: tasks.filter(t => t.completed).length,
            overdue: tasks.filter(t => isOverdue(t)).length,
            active: tasks.filter(t => !t.completed && !isOverdue(t)).length,
          }));
      }, [filteredTasks]);

      // ─── Chart Data ───
      const barChartData = useMemo(() => {
        return staffGroups.map(g => ({
          name: g.name.length > 14 ? g.name.slice(0, 12) + '…' : g.name,
          fullName: g.name,
          Active: g.active,
          Overdue: g.overdue,
          Complete: g.complete,
        }));
      }, [staffGroups]);

      const statusTotals = useMemo(() => {
        const complete = filteredTasks.filter(t => t.completed).length;
        const overdue = filteredTasks.filter(t => isOverdue(t)).length;
        const active = filteredTasks.length - complete - overdue;
        return [
          { name: 'Active', value: active, color: '#3b82f6' },
          { name: 'Complete', value: complete, color: '#22c55e' },
          { name: 'Overdue', value: overdue, color: '#ef4444' },
        ].filter(s => s.value > 0);
      }, [filteredTasks]);

      // ─── Project list for filter ───
      const projectOptions = useMemo(() => {
        const seen = {};
        tasks.forEach(t => {
          if (t['project-id'] && t['project-name']) {
            seen[t['project-id']] = t['project-name'];
          }
        });
        return Object.entries(seen).sort((a, b) => a[1].localeCompare(b[1]));
      }, [tasks]);

      const toggleCollapse = (name) => {
        setCollapsedStaff(prev => ({ ...prev, [name]: !prev[name] }));
      };

      const resetFilters = () => {
        setFilterProject('all');
        setFilterDateFrom('');
        setFilterDateTo('');
      };

      const hasActiveFilters = filterProject !== 'all' || filterDateFrom || filterDateTo;

      // ─── Custom Tooltip ───
      const CustomTooltip = ({ active, payload, label }) => {
        if (!active || !payload?.length) return null;
        const data = payload[0]?.payload;
        return (
          <div style={{
            background: '#1c1e28', border: '1px solid #2a2d3a',
            borderRadius: '8px', padding: '12px 16px', fontSize: '13px',
            boxShadow: '0 8px 24px rgba(0,0,0,0.4)'
          }}>
            <div style={{ fontWeight: 600, marginBottom: 6 }}>{data?.fullName || label}</div>
            {payload.map((p, i) => (
              <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 6, marginTop: 3 }}>
                <span style={{ width: 8, height: 8, borderRadius: '50%', background: p.color, display: 'inline-block' }} />
                <span style={{ color: '#9ca0b0' }}>{p.name}:</span>
                <span style={{ fontWeight: 600 }}>{p.value}</span>
              </div>
            ))}
          </div>
        );
      };

      return (
        <div>
          {/* Header */}
          <header className="header">
            <div className="header-left">
              <div className="logo">9C</div>
              <div>
                <div className="header-title">Teamwork Dashboard</div>
                <div className="header-subtitle">Tasks by Staff</div>
              </div>
            </div>
            <div className="header-actions">
              <button className={`btn btn-primary ${loading ? 'loading' : ''}`} onClick={fetchData}>
                ↻ Refresh
              </button>
            </div>
          </header>

          {/* Status Bar */}
          <div className="status-bar">
            <span>
              <span className={`status-dot ${error ? 'error' : loading ? 'loading' : ''}`} />
              {error ? 'Connection error' : loading ? 'Loading…' : 'Connected'}
            </span>
            {!loading && !error && (
              <>
                <span className="stat-chip">{filteredTasks.length} tasks</span>
                <span className="stat-chip">{staffGroups.length} staff</span>
                <span className="stat-chip">{projectOptions.length} projects</span>
                {lastUpdated && <span>Updated {lastUpdated.toLocaleTimeString()}</span>}
              </>
            )}
          </div>

          <div className="main">
            {error && (
              <div className="error-banner">
                ⚠ Failed to load data: {error}. Check your API configuration and try refreshing.
              </div>
            )}

            {/* Filters */}
            <div className="filters-bar">
              <div className="filter-group">
                <label className="filter-label">Project</label>
                <select className="filter-select" value={filterProject} onChange={e => setFilterProject(e.target.value)}>
                  <option value="all">All Projects</option>
                  {projectOptions.map(([id, name]) => (
                    <option key={id} value={id}>{name}</option>
                  ))}
                </select>
              </div>
              <div className="filter-group">
                <label className="filter-label">Deadline From</label>
                <input type="date" className="filter-date" value={filterDateFrom}
                  onChange={e => setFilterDateFrom(e.target.value)} />
              </div>
              <div className="filter-group">
                <label className="filter-label">Deadline To</label>
                <input type="date" className="filter-date" value={filterDateTo}
                  onChange={e => setFilterDateTo(e.target.value)} />
              </div>
              {hasActiveFilters && (
                <button className="filter-reset" onClick={resetFilters}>✕ Clear filters</button>
              )}

              <div className="view-toggle">
                <button className={viewMode === 'table' ? 'active' : ''} onClick={() => setViewMode('table')}>
                  ☰ Table
                </button>
                <button className={viewMode === 'chart' ? 'active' : ''} onClick={() => setViewMode('chart')}>
                  ◫ Charts
                </button>
              </div>
            </div>

            {loading ? (
              <div className="loading-state">
                <div className="spinner" />
                <div className="loading-text">Fetching tasks from Teamwork…</div>
              </div>
            ) : (
              <>
                {/* Charts View */}
                {viewMode === 'chart' && (
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 300px', gap: 20, marginBottom: 24 }}>
                    <div className="chart-section">
                      <div className="chart-header">
                        <div>
                          <div className="chart-title">Tasks by Staff Member</div>
                          <div className="chart-subtitle">Stacked by status</div>
                        </div>
                      </div>
                      <ResponsiveContainer width="100%" height={Math.max(280, staffGroups.length * 44)}>
                        <BarChart data={barChartData} layout="vertical" margin={{ left: 10, right: 20, top: 5, bottom: 5 }}>
                          <XAxis type="number" tick={{ fill: '#6b7084', fontSize: 12 }} axisLine={false} tickLine={false} />
                          <YAxis type="category" dataKey="name" width={120}
                            tick={{ fill: '#9ca0b0', fontSize: 12 }} axisLine={false} tickLine={false} />
                          <Tooltip content={<CustomTooltip />} cursor={{ fill: 'rgba(59,130,246,0.06)' }} />
                          <Bar dataKey="Active" stackId="a" fill="#3b82f6" radius={[0, 0, 0, 0]} />
                          <Bar dataKey="Overdue" stackId="a" fill="#ef4444" />
                          <Bar dataKey="Complete" stackId="a" fill="#22c55e" radius={[0, 4, 4, 0]} />
                        </BarChart>
                      </ResponsiveContainer>
                    </div>

                    <div className="chart-section">
                      <div className="chart-header">
                        <div>
                          <div className="chart-title">Task Status</div>
                          <div className="chart-subtitle">Overall breakdown</div>
                        </div>
                      </div>
                      <ResponsiveContainer width="100%" height={220}>
                        <PieChart>
                          <Pie data={statusTotals} cx="50%" cy="50%" innerRadius={55} outerRadius={85}
                            paddingAngle={3} dataKey="value">
                            {statusTotals.map((entry, i) => (
                              <Cell key={i} fill={entry.color} />
                            ))}
                          </Pie>
                          <Tooltip content={<CustomTooltip />} />
                        </PieChart>
                      </ResponsiveContainer>
                      <div style={{ display: 'flex', justifyContent: 'center', gap: 16, marginTop: 8 }}>
                        {statusTotals.map(s => (
                          <div key={s.name} style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 12 }}>
                            <span style={{ width: 8, height: 8, borderRadius: '50%', background: s.color, display: 'inline-block' }} />
                            <span style={{ color: '#9ca0b0' }}>{s.name}</span>
                            <span style={{ fontWeight: 600 }}>{s.value}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* Staff Sections */}
                {staffGroups.length === 0 ? (
                  <div className="empty-state">No tasks match your current filters.</div>
                ) : (
                  staffGroups.map(group => {
                    const collapsed = collapsedStaff[group.name];
                    return (
                      <div key={group.name} className="staff-section">
                        <div className="staff-header" onClick={() => toggleCollapse(group.name)}>
                          <div className="staff-info">
                            <div className="staff-avatar">{getInitials(group.name)}</div>
                            <span className="staff-name">{group.name}</span>
                            <div className="staff-badges">
                              <span className="badge badge-total">{group.total} tasks</span>
                              {group.overdue > 0 && <span className="badge badge-overdue">{group.overdue} overdue</span>}
                              <span className="badge badge-active">{group.active} active</span>
                              <span className="badge badge-complete">{group.complete} done</span>
                            </div>
                          </div>
                          <span className={`collapse-icon ${collapsed ? 'collapsed' : ''}`}>▾</span>
                        </div>
                        {!collapsed && (
                          <table className="task-table">
                            <thead>
                              <tr>
                                <th style={{ width: 30 }}></th>
                                <th>Task</th>
                                <th>Status</th>
                                <th>Deadline</th>
                                <th>Priority</th>
                              </tr>
                            </thead>
                            <tbody>
                              {group.tasks.map(task => {
                                const status = getTaskStatus(task);
                                const due = parseDate(task['due-date']);
                                const dateClass = status === 'overdue' ? 'date-overdue'
                                  : isUpcomingSoon(task) ? 'date-upcoming' : 'date-ok';
                                const prio = (task.priority || '').toLowerCase();
                                const prioClass = prio === 'high' ? 'priority-high'
                                  : prio === 'medium' ? 'priority-medium'
                                  : prio === 'low' ? 'priority-low' : 'priority-none';
                                return (
                                  <tr key={task.id}>
                                    <td>
                                      <span className={`priority-dot ${prioClass}`}
                                        title={prio || 'none'} />
                                    </td>
                                    <td className="task-name-cell">
                                      <div className="task-title">{task.content}</div>
                                      <span className="task-project-tag">{task['project-name']}</span>
                                    </td>
                                    <td>
                                      <span className={`status-badge status-${status}`}>
                                        {status === 'complete' ? '✓ Done'
                                          : status === 'overdue' ? '! Overdue'
                                          : '○ Active'}
                                      </span>
                                    </td>
                                    <td className="date-cell">
                                      {due ? (
                                        <span className={dateClass}>{formatDate(due)}</span>
                                      ) : (
                                        <span className="no-date">No deadline</span>
                                      )}
                                    </td>
                                    <td style={{ fontSize: 12, color: '#9ca0b0', textTransform: 'capitalize' }}>
                                      {prio || '—'}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        )}
                      </div>
                    );
                  })
                )}
              </>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
